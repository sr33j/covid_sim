<!DOCTYPE html>

<html>
	<head>
		<title>Network</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
		<script src="../animejs/lib/anime.min.js"></script>
		<style type="text/css">
			html {
	  			background: #add8e6;
			}
			.square {
				width: 20px;
				height: 20px;
				border: 4px solid #000;
				background-color: #FFF;
			}

			.selected {
				border-color: #ffb6c1;
			}

			.connect {
				width: 55px;
				height: 20px;
				position: absolute;
				top: 50px;
				left: 50px;
				background-color: #FFF;
				border: 3px solid #000;
				padding: 5px;
				margin: 10px;
			}

			.line {
		      stroke: #000;
		      stroke-width: 2px;	
		      position: absolute;
			}

			.circle {
				border-radius: 50%;
				width: 13px;
				height: 13px;
				background-color: #45B6FE;
			}

			svg {
			  position: absolute;
		      width: 100%;
		      height: 100%;
			}

		</style>
	</head>
	<body>
		<div class="connect">Connect</div>
	</body>
	<script type="text/javascript">
		const body = document.querySelector('body');
		var square_count = 0;
		var circle_count = 0;
		var graph = {};

		function addSquare(event) {

			var x_pos = event.clientX;
			var y_pos = event.clientY;

			var d = document.createElement('div');

			d.id = "s"+square_count;

			d.className = "square";

			d.style.position = "absolute";
			d.style.left = x_pos+'px';
			d.style.top = y_pos+'px';

			$('body').append(d);

			graph[d.id] = []

			$('.square').draggable({
				drag: updateLines
			}); 

			function selectSquare(e) {
				if ($(e.target).attr("class").includes('selected')) {
					$(e.target).attr("class", 'square');
				} 
				else {
					$(e.target).attr('class', 'square selected');
				}
			};

			function addCircle(e) {
				var p = document.createElement('div');

				p.id = "c"+circle_count;

				p.className = "circle";

				p.style.position = "absolute";
				p.style.left = x_pos+10+'px';
				p.style.top = y_pos+10+'px';
				$('body').append(p);

				var edges  = graph[$(e.target).attr("id")];

				var rand_index = Math.floor(Math.random() * edges.length);

				var new_id = graph[$(e.target).attr("id")][rand_index]

				var x_delta = $('#'+new_id).position().left - $(e.target).position().left;
				var y_delta = $('#'+new_id).position().top - $(e.target).position().top;

				anime({
				  targets: '.circle',
				  translateX: x_delta,
				  translateY: y_delta,
				  duration: 1000,
				  loop: true,
				  loopComplete: function(anim) {
					edges  = graph[new_id];

					rand_index = Math.floor(Math.random() * edges.length);

					x_delta = $('#'+graph[$(e.target).attr("id")][rand_index]).position().left - $(e.target).position().left;
					y_delta = $('#'+graph[$(e.target).attr("id")][rand_index]).position().top - $(e.target).position().top;
				  }
  				});

				circle_count+=1;
			};

			var timer = 0;
			var delay = 50;
			var prevent = false;

			$(".square")
			  .on("click", function(e) {
			  	e.stopImmediatePropagation();
			    timer = setTimeout(function() {
			      if (!prevent) {
			        selectSquare(e);
			      }
			      prevent = false;
			    }, delay);
			  })
			  .on("dblclick", function(e) {
			  	e.stopImmediatePropagation();
			    clearTimeout(timer);
			    prevent = true;
			    addCircle(e);
			  });

			square_count+=1;

		}

		function addLines(event) {
			event.stopImmediatePropagation();
			var nodes = $( ".selected" ).toArray()

			if (nodes.length == 0 || nodes.length == 1) {
				return;
			}

		  	for ( var i = 0; i < nodes.length-1; i++ ) {
		  		for ( var j = i+1; j < nodes.length; j++ ) {
					var s1 = nodes[i]  
					var s2 = nodes[j]

		  			if ( $('#l'+s1.id+s2.id).length ) {
		  				continue;
		  			}

		  			$('body').append('<svg style="pointer-events:none;"><line id="l'+s1.id+s2.id+'" class="line"></svg>');

		  			graph[s1.id].push(s2.id);
		  			graph[s2.id].push(s1.id);

		  			var line = $('#l'+s1.id+s2.id);   
					
					line
					  .attr('x1', s1.style.left)
					  .attr('y1', s1.style.top)
					  .attr('x2', s2.style.left)
					  .attr('y2', s2.style.top);
		    	}
		  	}

		  	$( ".selected" ).attr('class','square');
		}

		function updateLines(event, ui) {
			var square_id = $(event.target).attr('id');
			var lines = $("line[id*='"+square_id+"']").toArray();
			lines.forEach(
				function(line, index) {
					if (line.id.indexOf(square_id) == 1) {
						line.setAttribute('x1', $(event.target).css('left'));
						line.setAttribute('y1', $(event.target).css('top'));
					}
					else { //it's at index 3, denoting the second square
						line.setAttribute('x2', $(event.target).css('left'));
						line.setAttribute('y2', $(event.target).css('top'));
					}
				}
			);
		}

		$(document).click(addSquare);

		$('.connect').click(addLines);



	</script>
</html>